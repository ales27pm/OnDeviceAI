# Security Scanning and Compliance
# Comprehensive security analysis and vulnerability management

name: ðŸ”’ Security & Compliance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - dependencies
          - secrets
          - code_analysis
          - compliance

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  # ðŸ” Dependency Vulnerability Scanning
  dependency_scan:
    name: ðŸ” Dependency Vulnerabilities
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event.inputs.scan_type == 'comprehensive' ||
      github.event.inputs.scan_type == 'dependencies' ||
      github.event.inputs.scan_type == ''
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ¥Ÿ Install Bun
        uses: oven-sh/setup-bun@v1
        
      - name: ðŸ“¦ Install Dependencies
        run: bun install --frozen-lockfile
        
      - name: ðŸ” Audit JavaScript Dependencies
        run: |
          echo "ðŸ” Scanning JavaScript dependencies..."
          
          # Bun audit
          bun audit --audit-level moderate --json > bun-audit.json || true
          
          # Parse and format results
          if [ -f bun-audit.json ]; then
            echo "ðŸ“Š Bun Audit Results:"
            cat bun-audit.json | head -20
          fi
          
      - name: ðŸ” OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        id: depcheck
        with:
          project: 'OnDeviceAI'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --failOnCVSS 7
            --exclude "**/node_modules/**"
            --exclude "**/ios/Pods/**"
          
      - name: ðŸ“Š Parse Dependency Results
        run: |
          echo "ðŸ“Š Dependency Scan Summary" > dependency-report.md
          echo "==========================" >> dependency-report.md
          echo "" >> dependency-report.md
          
          if [ -f reports/dependency-check-report.json ]; then
            # Parse JSON report and extract key information
            VULNERABILITIES=$(cat reports/dependency-check-report.json | jq '.dependencies[]?.vulnerabilities[]?' 2>/dev/null | wc -l || echo "0")
            echo "- **Total Vulnerabilities Found**: $VULNERABILITIES" >> dependency-report.md
            echo "" >> dependency-report.md
            
            # Extract high severity vulnerabilities
            HIGH_VULN=$(cat reports/dependency-check-report.json | jq '.dependencies[]?.vulnerabilities[]? | select(.severity == "HIGH")' 2>/dev/null | wc -l || echo "0")
            MEDIUM_VULN=$(cat reports/dependency-check-report.json | jq '.dependencies[]?.vulnerabilities[]? | select(.severity == "MEDIUM")' 2>/dev/null | wc -l || echo "0")
            
            echo "- **High Severity**: $HIGH_VULN" >> dependency-report.md
            echo "- **Medium Severity**: $MEDIUM_VULN" >> dependency-report.md
            echo "" >> dependency-report.md
          else
            echo "- **Status**: âœ… No vulnerabilities detected" >> dependency-report.md
            echo "" >> dependency-report.md
          fi
          
          echo "## ðŸ”§ Recommendations" >> dependency-report.md
          echo "" >> dependency-report.md
          echo "1. ðŸ“¦ Keep dependencies updated regularly" >> dependency-report.md
          echo "2. ðŸ” Review and address high-severity vulnerabilities" >> dependency-report.md
          echo "3. ðŸ›¡ï¸ Consider using dependency lock files" >> dependency-report.md
          echo "4. ðŸš« Remove unused dependencies" >> dependency-report.md
          
      - name: ðŸ“¤ Upload Dependency Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-results
          path: |
            reports/
            dependency-report.md
            bun-audit.json
          retention-days: 30

  # ðŸ” Secrets Scanning
  secrets_scan:
    name: ðŸ” Secrets & Credentials Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      github.event.inputs.scan_type == 'comprehensive' ||
      github.event.inputs.scan_type == 'secrets' ||
      github.event.inputs.scan_type == ''
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ” TruffleHog Secrets Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified
          
      - name: ðŸ” Manual Secrets Patterns
        run: |
          echo "ðŸ” Scanning for potential secrets and sensitive data..."
          
          # Create secrets scan report
          echo "# ðŸ” Secrets Scan Report" > secrets-report.md
          echo "" >> secrets-report.md
          
          # Common secret patterns
          PATTERNS=(
            "api[_-]?key"
            "secret[_-]?key"
            "access[_-]?token"
            "auth[_-]?token"
            "password"
            "passwd"
            "private[_-]?key"
            "client[_-]?secret"
            "aws[_-]?access"
            "bearer[[:space:]]"
          )
          
          FOUND_SECRETS=false
          
          for pattern in "${PATTERNS[@]}"; do
            RESULTS=$(grep -r -i -n "$pattern" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=.git . || true)
            
            if [ -n "$RESULTS" ]; then
              echo "## âš ï¸ Pattern: $pattern" >> secrets-report.md
              echo '```' >> secrets-report.md
              echo "$RESULTS" >> secrets-report.md
              echo '```' >> secrets-report.md
              echo "" >> secrets-report.md
              FOUND_SECRETS=true
            fi
          done
          
          if [ "$FOUND_SECRETS" = false ]; then
            echo "## âœ… No Obvious Secrets Found" >> secrets-report.md
            echo "" >> secrets-report.md
            echo "No common secret patterns were detected in the codebase." >> secrets-report.md
          else
            echo "## ðŸ”§ Recommendations" >> secrets-report.md
            echo "" >> secrets-report.md
            echo "1. ðŸ” Move secrets to environment variables" >> secrets-report.md
            echo "2. ðŸ—ï¸ Use GitHub Secrets for CI/CD" >> secrets-report.md
            echo "3. ðŸ”„ Rotate any exposed credentials" >> secrets-report.md
            echo "4. ðŸ“ Review .gitignore for sensitive files" >> secrets-report.md
          fi
          
      - name: ðŸ“¤ Upload Secrets Report
        uses: actions/upload-artifact@v4
        with:
          name: secrets-scan-results
          path: secrets-report.md
          retention-days: 30

  # ðŸ”¬ Static Code Analysis
  code_analysis:
    name: ðŸ”¬ Static Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: |
      github.event.inputs.scan_type == 'comprehensive' ||
      github.event.inputs.scan_type == 'code_analysis' ||
      github.event.inputs.scan_type == ''
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript
          config-file: ./.github/codeql-config.yml
          
      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3
        
      - name: ðŸ”¬ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"
          
      - name: ðŸŸ¢ Setup Node.js for ESLint Security
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ¥Ÿ Install Bun
        uses: oven-sh/setup-bun@v1
        
      - name: ðŸ“¦ Install Dependencies
        run: bun install --frozen-lockfile
        
      - name: ðŸ” ESLint Security Analysis
        run: |
          echo "ðŸ” Running ESLint security analysis..."
          
          # Install security plugins
          bun add -D eslint-plugin-security eslint-plugin-no-secrets
          
          # Create security-focused ESLint config
          cat > .eslintrc.security.js << EOF
          module.exports = {
            extends: [
              './.eslintrc.js'
            ],
            plugins: [
              'security',
              'no-secrets'
            ],
            rules: {
              'security/detect-object-injection': 'error',
              'security/detect-non-literal-regexp': 'error',
              'security/detect-unsafe-regex': 'error',
              'security/detect-buffer-noassert': 'error',
              'security/detect-child-process': 'error',
              'security/detect-disable-mustache-escape': 'error',
              'security/detect-eval-with-expression': 'error',
              'security/detect-no-csrf-before-method-override': 'error',
              'security/detect-non-literal-fs-filename': 'error',
              'security/detect-non-literal-require': 'error',
              'security/detect-possible-timing-attacks': 'error',
              'security/detect-pseudoRandomBytes': 'error',
              'no-secrets/no-secrets': 'error'
            }
          };
          EOF
          
          # Run security linting
          bun x eslint src/ --config .eslintrc.security.js --format json > eslint-security.json || true
          
          # Parse results
          if [ -f eslint-security.json ]; then
            ISSUES=$(cat eslint-security.json | jq '[.[].messages[]] | length' 2>/dev/null || echo "0")
            echo "ðŸ“Š ESLint Security Issues Found: $ISSUES"
          fi
          
      - name: ðŸ“Š Generate Code Analysis Report
        run: |
          echo "# ðŸ”¬ Static Code Analysis Report" > code-analysis-report.md
          echo "" >> code-analysis-report.md
          
          echo "## ðŸ“Š Analysis Summary" >> code-analysis-report.md
          echo "" >> code-analysis-report.md
          
          if [ -f eslint-security.json ]; then
            ISSUES=$(cat eslint-security.json | jq '[.[].messages[]] | length' 2>/dev/null || echo "0")
            echo "- **ESLint Security Issues**: $ISSUES" >> code-analysis-report.md
          fi
          
          echo "- **CodeQL Analysis**: âœ… Completed" >> code-analysis-report.md
          echo "" >> code-analysis-report.md
          
          echo "## ðŸ”§ Security Best Practices" >> code-analysis-report.md
          echo "" >> code-analysis-report.md
          echo "1. ðŸ” Regular static analysis scanning" >> code-analysis-report.md
          echo "2. ðŸ›¡ï¸ Input validation and sanitization" >> code-analysis-report.md
          echo "3. ðŸ” Secure credential management" >> code-analysis-report.md
          echo "4. ðŸ“ Security-focused code reviews" >> code-analysis-report.md
          echo "5. ðŸ”„ Automated security testing" >> code-analysis-report.md
          
      - name: ðŸ“¤ Upload Code Analysis Results
        uses: actions/upload-artifact@v4
        with:
          name: code-analysis-results
          path: |
            code-analysis-report.md
            eslint-security.json
          retention-days: 30

  # ðŸ“‹ Compliance & Licensing
  compliance_check:
    name: ðŸ“‹ Compliance & Licensing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event.inputs.scan_type == 'comprehensive' ||
      github.event.inputs.scan_type == 'compliance' ||
      github.event.inputs.scan_type == ''
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ðŸ¥Ÿ Install Bun
        uses: oven-sh/setup-bun@v1
        
      - name: ðŸ“¦ Install Dependencies
        run: bun install --frozen-lockfile
        
      - name: ðŸ“‹ License Compliance Check
        run: |
          echo "ðŸ“‹ Checking license compliance..."
          
          # Install license checker
          npm install -g license-checker
          
          # Generate license report
          license-checker --json > licenses.json
          license-checker --csv > licenses.csv
          
          # Analyze licenses
          echo "# ðŸ“‹ License Compliance Report" > compliance-report.md
          echo "" >> compliance-report.md
          
          # Count licenses by type
          if [ -f licenses.json ]; then
            TOTAL_DEPS=$(cat licenses.json | jq 'keys | length' 2>/dev/null || echo "0")
            echo "- **Total Dependencies**: $TOTAL_DEPS" >> compliance-report.md
            echo "" >> compliance-report.md
            
            # Check for restrictive licenses
            RESTRICTIVE_LICENSES=("GPL" "AGPL" "LGPL" "SSPL")
            FOUND_RESTRICTIVE=false
            
            for license in "${RESTRICTIVE_LICENSES[@]}"; do
              COUNT=$(grep -i "$license" licenses.csv | wc -l || echo "0")
              if [ "$COUNT" -gt 0 ]; then
                echo "- **$license Licenses**: $COUNT âš ï¸" >> compliance-report.md
                FOUND_RESTRICTIVE=true
              fi
            done
            
            if [ "$FOUND_RESTRICTIVE" = false ]; then
              echo "- **License Status**: âœ… No restrictive licenses detected" >> compliance-report.md
            fi
          fi
          
          echo "" >> compliance-report.md
          echo "## ðŸ”§ Compliance Recommendations" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "1. ðŸ“ Review all dependency licenses" >> compliance-report.md
          echo "2. ðŸš« Avoid GPL/AGPL licenses for commercial use" >> compliance-report.md
          echo "3. ðŸ“‹ Maintain license documentation" >> compliance-report.md
          echo "4. ðŸ”„ Regular license audits" >> compliance-report.md
          
      - name: ðŸ” Privacy Compliance Check
        run: |
          echo "" >> compliance-report.md
          echo "## ðŸ”’ Privacy Compliance" >> compliance-report.md
          echo "" >> compliance-report.md
          
          # Check for data collection patterns
          DATA_COLLECTION_PATTERNS=(
            "analytics"
            "tracking"
            "telemetry"
            "crashlytics"
            "firebase"
            "amplitude"
            "mixpanel"
          )
          
          FOUND_TRACKING=false
          
          for pattern in "${DATA_COLLECTION_PATTERNS[@]}"; do
            RESULTS=$(grep -r -i "$pattern" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules . | wc -l || echo "0")
            if [ "$RESULTS" -gt 0 ]; then
              echo "- **$pattern**: $RESULTS occurrences found" >> compliance-report.md
              FOUND_TRACKING=true
            fi
          done
          
          if [ "$FOUND_TRACKING" = false ]; then
            echo "- **Data Collection**: âœ… No obvious tracking detected" >> compliance-report.md
          fi
          
          echo "" >> compliance-report.md
          echo "### ðŸ“ Privacy Recommendations" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "1. ðŸ”’ Implement privacy-by-design principles" >> compliance-report.md
          echo "2. ðŸ“ Maintain clear privacy policy" >> compliance-report.md
          echo "3. ðŸ›¡ï¸ Minimize data collection" >> compliance-report.md
          echo "4. ðŸ” Encrypt sensitive data" >> compliance-report.md
          
      - name: ðŸ“¤ Upload Compliance Report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-results
          path: |
            compliance-report.md
            licenses.json
            licenses.csv
          retention-days: 30

  # ðŸ“Š Security Summary
  security_summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [dependency_scan, secrets_scan, code_analysis, compliance_check]
    if: always()
    
    steps:
      - name: ðŸ“¥ Download All Security Reports
        uses: actions/download-artifact@v4
        
      - name: ðŸ“Š Generate Security Summary
        run: |
          echo "# ðŸ”’ Security & Compliance Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "## ðŸ“Š Scan Results" >> security-summary.md
          echo "" >> security-summary.md
          echo "| Category | Status | Details |" >> security-summary.md
          echo "|----------|--------|---------|" >> security-summary.md
          echo "| Dependencies | ${{ needs.dependency_scan.result == 'success' && 'âœ… Scanned' || 'âŒ Failed' }} | Vulnerability analysis completed |" >> security-summary.md
          echo "| Secrets | ${{ needs.secrets_scan.result == 'success' && 'âœ… Scanned' || 'âŒ Failed' }} | Credential leak detection |" >> security-summary.md
          echo "| Code Analysis | ${{ needs.code_analysis.result == 'success' && 'âœ… Analyzed' || 'âŒ Failed' }} | Static security analysis |" >> security-summary.md
          echo "| Compliance | ${{ needs.compliance_check.result == 'success' && 'âœ… Checked' || 'âŒ Failed' }} | License & privacy compliance |" >> security-summary.md
          echo "" >> security-summary.md
          
          # Overall security score
          PASSED_SCANS=0
          TOTAL_SCANS=4
          
          [ "${{ needs.dependency_scan.result }}" = "success" ] && PASSED_SCANS=$((PASSED_SCANS + 1))
          [ "${{ needs.secrets_scan.result }}" = "success" ] && PASSED_SCANS=$((PASSED_SCANS + 1))
          [ "${{ needs.code_analysis.result }}" = "success" ] && PASSED_SCANS=$((PASSED_SCANS + 1))
          [ "${{ needs.compliance_check.result }}" = "success" ] && PASSED_SCANS=$((PASSED_SCANS + 1))
          
          SCORE=$((PASSED_SCANS * 100 / TOTAL_SCANS))
          
          echo "## ðŸŽ¯ Security Score: ${SCORE}%" >> security-summary.md
          echo "" >> security-summary.md
          
          if [ $SCORE -eq 100 ]; then
            echo "ðŸŽ‰ **Excellent!** All security scans passed." >> security-summary.md
          elif [ $SCORE -ge 75 ]; then
            echo "ðŸ‘ **Good!** Most security scans passed." >> security-summary.md
          elif [ $SCORE -ge 50 ]; then
            echo "âš ï¸ **Warning!** Some security issues detected." >> security-summary.md
          else
            echo "ðŸš¨ **Critical!** Multiple security issues found." >> security-summary.md
          fi
          
          echo "" >> security-summary.md
          echo "## ðŸ”§ Next Steps" >> security-summary.md
          echo "" >> security-summary.md
          echo "1. ðŸ“ Review individual scan reports" >> security-summary.md
          echo "2. ðŸ”§ Address any high-priority issues" >> security-summary.md
          echo "3. ðŸ“‹ Update security documentation" >> security-summary.md
          echo "4. ðŸ”„ Schedule regular security reviews" >> security-summary.md
          echo "" >> security-summary.md
          echo "---" >> security-summary.md
          echo "*Security scan completed on $(date -u +"%Y-%m-%d %H:%M:%S UTC")*" >> security-summary.md
          
      - name: ðŸ“¤ Upload Security Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 90

      - name: ðŸš¨ Security Alert
        if: |
          needs.dependency_scan.result == 'failure' ||
          needs.secrets_scan.result == 'failure' ||
          needs.code_analysis.result == 'failure' ||
          needs.compliance_check.result == 'failure'
        run: |
          echo "ðŸš¨ Security issues detected!"
          echo "Please review the security reports and address any critical vulnerabilities."
          
          # In a real setup, this could send alerts to Slack, email, etc.
          exit 1